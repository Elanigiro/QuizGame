import { UserResult } from "../payload/request/UserResult.js";
import { DiffVersionScore } from "../payload/response/DiffVersionScore.js";
import { Question } from "../payload/response/Question.js";
import { QuestionList } from "../payload/response/QuestionList.js";
import { User } from "../payload/response/User.js";
import { UserScore } from "../payload/response/UserScore.js";

/**
 * Static class to handle all REST requests/responses to the Back-End
 */
class ClientSideREST {

    static URL_QUIZ_Q = "/quiz/questions";
    static URL_QUIZ_Q_TOPIC = "/quiz/questions/topic";
    static URL_QUIZ_SCORES = "/quiz/scores" /* /{version}/{difficulty} */;
    static URL_LDRBOARD = "/users?leaderboard=true";
    static URL_USER = "/users";
    static URL_USER_SRCH_BY_USRNM = "/users?username";
    static URL_USER_SCORES = /* '/users/:id/' */"scores";

    /**
     * @throws {Error}
     */
    constructor () {

        throw new Error('Constructor Not Available!');
    }

    /**
     * 
     * @param {number} id 
     * @returns {Promise<Question>}
     */
    static async fetchOneQuestion(id) {

        if ((parseInt(id) !== id) || (id <= 0)) {

            throw new Error('id must be a positive integer!');
        }

        const res = await fetch(`${this.URL_QUIZ_Q}/${id}`);

        if (!res.ok) {

            throw new Error(`Request was unsuccessful!\n Code: ${res.status}`);
        }

        const responseJson = await res.json();

        return Question.fromJson(responseJson);
    }

    /**
     * @param {number} topicId
     * @param {number} limit
     * @param {boolean} random
     * @returns {Promise<QuestionList>}
     */
    static async fetchQuizQuestionList(topicId, limit, random) {

        const res = await fetch(`${this.URL_QUIZ_Q_TOPIC}/${topicId}?limit=${limit}&random=${random}`);

        if (!res.ok) {

            throw new Error(`Request was unsuccessful!\n Code: ${res.status}`);
        }

        const responseJson = await res.json();

        return QuestionList.fromJson(responseJson);
    }

    /**
     * 
     * @param {number} version 
     * @param {number} difficulty 
     * @returns {Promise<DiffVersionScore>}
     */
    static async fetchDiffVersionScore(version, difficulty) {

        const res = await fetch(`${this.URL_QUIZ_SCORES}/${version}/${difficulty}`);

        if (!res.ok) {

            throw new Error(`Request was unsuccessful!\n Code: ${res.status}`);
        }

        const responseJson = await res.json();

        return DiffVersionScore.fromJson(responseJson);
    }

    /**
     * @returns {Promise<UserScore[]>}
     */
    static async fetchLeaderboard() {

        const res = await fetch(`${this.URL_LDRBOARD}`);

        if (!res.ok) {

            throw new Error(`Request was unsuccessful!\n Code: ${res.status}`);
        }

        const responseJson = await res.json();

        return responseJson.map((item) => UserScore.fromJson(item));
    }

    /**
     * @param {string} username
     * @returns {Promise<string>}
     */
    static async postNewUser(username) {

        const res = await fetch(`${this.URL_USER}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json;charset=UTF-8'},
            body: JSON.stringify({"username": username}),
        });

        if (!res.ok) {

            throw new Error(`Request was unsuccessful!\n Code: ${res.status}`);
        }

        return res.text(); //it's supposed to be the id generated by the server
    }


    /**
     * @param {string} username
     * @param {UserResult} ur
     * @returns {Promise<any>}
     */
    static async sendUserScore(username, ur) {

        let userId = null;

        const res = await fetch(`${this.URL_USER_SRCH_BY_USRNM}=${username}`);

        if (res.ok) {

            const responseJson = await res.json();
            const usr = User.fromJson(responseJson);

            userId = usr.id;
        }
        else if (res.status === 404) {

            userId = await this.postNewUser(username);
        }
        else {

            throw new Error(`Request was unsuccessful!\n Code: ${res.status}`);
        }

        const res2 = await fetch(`${this.URL_USER}/${userId}/${this.URL_USER_SCORES}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json;charset=UTF-8'},
            body: JSON.stringify(ur),
        });

        if (!res2.ok) {

            throw new Error(`Request was unsuccessful!\n Code: ${res2.status}`);
        }
    }
}

export {ClientSideREST};